<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Mario</title>
    </head>
    <body>
        <canvas id="canvas" width="640" height="640"></canvas>
        <br/>
        <button class='config-btn' data-key='byteNum' data-value='-1024'>prev</button>
        <button class='config-btn' data-key='byteNum' data-value='1024'>next</button>
        <span class='config-val' data-key='byteNum'>0</span>
<script>
const e = sel => document.querySelector(sel)
const es = sel => Array.from(document.querySelectorAll(sel))
const log = console.log.bind(console)

/*
8x8 像素 / 图块
2 bits / 像素
16 bytes / 图块

每页 8X8 个图块 canvas 宽高画 64 像素
1024 byte / 页
 */

const configInit = () => {
    window.config = {
        byteNum: 32768 
    }
}

const bindAll = () => {
    es('.config-btn').forEach(ele => {
        ele.addEventListener('click', ev => {
            const t = ev.target
            if (t.dataset.key) {
                eval(`window.config.${t.dataset.key} += ${Number(t.dataset.value)}`)
                es('.config-val').forEach(ele => ele.innerHTML = window.config[ele.dataset.key])
                log('click', window.config)
                drawNes()
            }
        })
    })
}

const drawPixel = (p, offsetX, offsetY) => {
    // log(p)
    // offsetX *= 1
    // offsetY *= 4
    const pixelSize = 10
    const colors = [
        'white',
        '#fbb100',
        '#716900',
        '#dc0000',
    ]
    const x = (offsetX) * pixelSize
    const y = (offsetY) * pixelSize
    const x2 = x + pixelSize
    const y2 = y + pixelSize
    const ctx = e('#canvas').getContext('2d')
    ctx.fillStyle = colors[Number(p)]
    ctx.fillRect(x, y, x2, y2)
}

const drawBlock = (block, offsetX, offsetY) => {
    // log('block', block.length, block, block.map(b => b.toString(2)))
    offsetX *= 8
    offsetY *= 8
    for (let i = 0; i < 8; i++) {
        const p1 = block[i]
        const p2 = block[i + 1]
        let result = []
        for (let j = 0; j < 8; j++) {
            // debugger
            const c1 = p1 >> (7 - j) & 0b00000001
            const c2 = p2 >> (7 - j) & 0b00000001
            const p = c1 << 1 | c2
            const x = offsetX + j
            const y = offsetY + i
            result.push(p)
            drawPixel(p, x, y)
        }
        // log(result)
        // let twoByte = block[i] << 8 | block[i + 1]
        // // log(twoByte.toString(2), block[i].toString(2), block[i + 1].toString(2))
        // twoByte = twoByte.toString(4)
        // for (let j = 0; j < 8; j++) {
        //     const p = twoByte[j]
        //     const x = offsetX + j
        //     const y = offsetY + i
        //     drawPixel(p, x, y)
        // }
    }
}

const drawPage = () => {
    const page = getPage(window.bytes)
    log('page', page, page.length)
    let index = 0
    for (let i = 0; i < 8; i++) {
        for (let j = 0; j < 8; j++) {
            const block = page.slice(0).splice(index, 16)
            drawBlock(block, j, i)
            index += 16
        }
    }
}

const drawNes = () => {
    /*
    78, 69, 83, 26
     */
    // log('bytes', bytes)
    drawPage()
}

const ajax = request => {
    let r = new XMLHttpRequest()
    r.open('GET', request.url, true)
    r.responseType = 'arraybuffer'
    r.onreadystatechange = ev => {
        if (r.readyState === 4) {
            request.cb(r.response)
        }
    }
    r.send()
}

const loadData = next => {
    let request = {
        url: 'mario1.nes',
        cb(r) {
            window.bytes = new Uint8Array(r)
            next()
        }
    }
    ajax(request)
}

const getPage = bytes => {
    const index = window.config.byteNum
    return Array.from(bytes).slice(0).splice(index, 1024)
}

const __main = () => {
    configInit()
    loadData(drawNes)
    bindAll()
}

__main()
</script>

    </body>
</html>
